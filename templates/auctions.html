{% extends 'base.html' %}

{% block title %}Auctions - NHL Instant Replay Bidding{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Live Auctions</h1>
            <p class="lead">Bid on upcoming moments in NHL games</p>
        </div>
    </div>

    <!-- Auction Control Panel (for admin users) -->
{% if user and user.get('is_admin', False) %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Admin Controls</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('process_auctions_route') }}" class="btn btn-warning">
                    <i class="fas fa-sync me-2"></i> Process All Auctions
                </a>
                <a href="{{ url_for('create_auction_form') }}" class="btn btn-success ms-2">
                    <i class="fas fa-plus-circle me-2"></i> Create New Auction
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

    <!-- Active Auctions Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>Active Auctions</h2>
            {% if active_auctions %}
                <div class="row">
                    {% for auction_id, auction in active_auctions.items() %}
                    <div class="col-md-6 mb-4">
                        <div class="card auction-card">
                            <div class="card-header">
                                {% set moment = moments.get(auction.moment_id, {}) %}
                                <h5 class="mb-0">{{ moment.get('name', 'Unknown Moment') }}</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {% set game = None %}
                                    {% for g in upcoming_games %}
                                        {% if g.id == auction.game_id %}
                                            {% set game = g %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if game %}
                                        <h6>{{ game.away }} @ {{ game.home }}</h6>
                                        <p class="text-muted">{{ game.date }} | {{ game.time }}</p>
                                    {% else %}
                                        <h6>Game ID: {{ auction.game_id }}</h6>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5>Current Bid:</h5>
                                            <h3 class="text-primary">${{ "{:,.2f}".format(auction.current_high_bid) }}</h3>
                                        </div>
                                        <div class="text-end">
                                            <p class="mb-0">Minimum Bid:</p>
                                            <p class="fs-5">${{ "{:,.2f}".format(auction.current_high_bid + auction.increment_amount) }}</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <p><strong>Auction Ends:</strong> {{ auction.end_time }}</p>
                                    <div class="progress mb-2">
                                        {% set now = now|default(datetime.now()) %}
                                        {% set start = auction.start_time|default(now) %}
                                        {% set end = auction.end_time|default(now) %}
                                        {% set progress = ((now - start) / (end - start) * 100)|round|int %}
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             style="width: {{ progress }}%;" 
                                             aria-valuenow="{{ progress }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                             {{ progress }}%
                                        </div>
                                    </div>
                                </div>

                                <form action="{{ url_for('place_bid_route', auction_id=auction_id) }}" method="POST" class="bid-form">
                                    <div class="row g-3 align-items-center">
                                        <div class="col-md-7">
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" 
                                                       class="form-control" 
                                                       name="bid_amount" 
                                                       id="bid_amount_{{ auction_id }}" 
                                                       min="{{ auction.current_high_bid + auction.increment_amount }}" 
                                                       step="100"
                                                       value="{{ auction.current_high_bid + auction.increment_amount }}"
                                                       required>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-gavel me-1"></i> Place Bid
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="card-footer">
                                <a href="{{ url_for('auction_detail', auction_id=auction_id) }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-info-circle me-1"></i> View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> There are no active auctions at the moment. Please check back later.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Upcoming Auctions Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>Upcoming Auctions</h2>
            {% if upcoming_auctions %}
                <div class="row">
                    {% for auction_id, auction in upcoming_auctions.items() %}
                    <div class="col-md-6 mb-4">
                        <div class="card auction-card">
                            <div class="card-header bg-light">
                                {% set moment = moments.get(auction.moment_id, {}) %}
                                <h5 class="mb-0">{{ moment.get('name', 'Unknown Moment') }}</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {% set game = None %}
                                    {% for g in upcoming_games %}
                                        {% if g.id == auction.game_id %}
                                            {% set game = g %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if game %}
                                        <h6>{{ game.away }} @ {{ game.home }}</h6>
                                        <p class="text-muted">{{ game.date }} | {{ game.time }}</p>
                                    {% else %}
                                        <h6>Game ID: {{ auction.game_id }}</h6>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <h5>Starting Bid:</h5>
                                    <h3 class="text-primary">${{ "{:,.2f}".format(auction.base_price) }}</h3>
                                </div>

                                <div class="mb-3">
                                    <p><strong>Auction Starts:</strong> {{ auction.start_time }}</p>
                                    <p><strong>Auction Ends:</strong> {{ auction.end_time }}</p>
                                </div>
                            </div>
                            <div class="card-footer">
                                <a href="{{ url_for('auction_detail', auction_id=auction_id) }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-info-circle me-1"></i> View Details
                                </a>
                                
                                <button type="button" class="btn btn-outline-secondary btn-sm float-end" data-bs-toggle="modal" data-bs-target="#reminderModal" data-auction-id="{{ auction_id }}">
                                    <i class="fas fa-bell me-1"></i> Set Reminder
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> There are no upcoming auctions scheduled. Please check back later.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Completed Auctions Section -->
    <div class="row">
        <div class="col-12">
            <h2>Recently Completed Auctions</h2>
            {% if completed_auctions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Moment</th>
                                <th>Game</th>
                                <th>Winning Bid</th>
                                <th>Winner</th>
                                <th>End Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for auction_id, auction in completed_auctions.items() %}
                            <tr>
                                <td>
                                    {% set moment = moments.get(auction.moment_id, {}) %}
                                    {{ moment.get('name', 'Unknown Moment') }}
                                </td>
                                <td>
                                    {% set game = None %}
                                    {% for g in upcoming_games %}
                                        {% if g.id == auction.game_id %}
                                            {% set game = g %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if game %}
                                        {{ game.away }} @ {{ game.home }}
                                    {% else %}
                                        Game ID: {{ auction.game_id }}
                                    {% endif %}
                                </td>
                                <td>${{ "{:,.2f}".format(auction.current_high_bid) }}</td>
                                <td>
                                    {% if auction.current_high_bidder_id %}
                                        {% set winner = users.get(auction.current_high_bidder_id, {}) %}
                                        {{ winner.get('name', 'Unknown User') }}
                                    {% else %}
                                        No bids
                                    {% endif %}
                                </td>
                                <td>{{ auction.end_time }}</td>
                                <td>
                                    <a href="{{ url_for('auction_detail', auction_id=auction_id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-info-circle"></i> Details
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No auctions have been completed recently.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Reminder Modal -->
<div class="modal fade" id="reminderModal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reminderModalLabel">Set Auction Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>We'll send you a notification when this auction starts.</p>
                <form id="reminderForm">
                    <input type="hidden" id="reminder_auction_id" name="auction_id" value="">
                    <div class="mb-3">
                        <label for="reminder_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="reminder_email" name="email" value="{{ user.email if user else '' }}" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="reminder_sms" name="sms_reminder">
                        <label class="form-check-label" for="reminder_sms">
                            Also send SMS reminder
                        </label>
                    </div>
                    <div class="mb-3 sms-field" style="display: none;">
                        <label for="reminder_phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="reminder_phone" name="phone" placeholder="+1 (123) 456-7890">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveReminderBtn">Set Reminder</button>
            </div>
        </div>
    </div>
</div>

<style>
    .auction-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .auction-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle SMS checkbox toggle
        const smsCheckbox = document.getElementById('reminder_sms');
        const smsField = document.querySelector('.sms-field');
        
        if (smsCheckbox && smsField) {
            smsCheckbox.addEventListener('change', function() {
                smsField.style.display = this.checked ? 'block' : 'none';
            });
        }
        
        // Set auction ID in reminder modal
        const reminderModal = document.getElementById('reminderModal');
        if (reminderModal) {
            reminderModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const auctionId = button.getAttribute('data-auction-id');
                document.getElementById('reminder_auction_id').value = auctionId;
            });
        }
        
        // Handle reminder submission
        const saveReminderBtn = document.getElementById('saveReminderBtn');
        if (saveReminderBtn) {
            saveReminderBtn.addEventListener('click', function() {
                // Here you would implement the actual reminder setting
                // For now, we'll just dismiss the modal and show a success message
                const modal = bootstrap.Modal.getInstance(reminderModal);
                modal.hide();
                
                // Show success alert
                const alertDiv = document.createElement('div');
                alertDiv.classList.add('alert', 'alert-success', 'alert-dismissible', 'fade', 'show');
                alertDiv.setAttribute('role', 'alert');
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i> Reminder set successfully! We'll notify you when the auction starts.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Insert at the top of the content
                const content = document.querySelector('.container');
                content.insertBefore(alertDiv, content.firstChild);
                
                // Auto-dismiss after 5 seconds
                setTimeout(function() {
                    alertDiv.classList.remove('show');
                    setTimeout(function() {
                        alertDiv.remove();
                    }, 1000);
                }, 5000);
            });
        }
    });
</script>
{% endblock %}
