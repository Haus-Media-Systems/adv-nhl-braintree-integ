{% extends 'base.html' %}

{% block title %}Set Up Bidding Strategy - NHL Instant Replay Bidding{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item">
                    {% if moment and 'id' in moment %}
                        <a href="{{ url_for('moment_detail', moment_id=moment['id']) }}">{{ moment['name'] }}</a>
                    {% else %}
                        <span>{{ moment.get('name', 'Unknown Moment') }}</span>
                    {% endif %}
                </li>
                <li class="breadcrumb-item active" aria-current="page">Set Up Strategy</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <h1>{% if existing_strategies %}Edit{% else %}Create{% endif %} Automated Bidding Strategies</h1>
        <p class="lead">Configure how your brand will bid on {{ moment['name'] }} moments during NHL games</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Strategy Configuration</h4>
                <div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="addStrategyBtn" title="Add Strategy">
                        <i class="fas fa-plus me-1"></i> Add Strategy
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('setup_strategy', moment_id=moment['id']) }}" id="multiStrategyForm">

                    <!-- Selected Moment Display -->
                    <div class="mb-4">
                        <h5>Selected Moment</h5>
                        <div class="d-flex align-items-center p-3 bg-light rounded">
                            <i class="fas fa-hockey-puck fa-2x me-3 text-primary"></i>
                            <div>
                                <h5 class="mb-0">{{ moment['name'] }}</h5>
                                <p class="mb-0 text-muted">{{ moment['description'] }}</p>
                            </div>
                            <div class="ms-auto">
                                <span class="badge bg-primary">{{ moment['exposure'] }} Exposure</span>
                            </div>
                        </div>
                    </div>

                    <!-- Game Selection -->
                    <div class="mb-4">
                        <h5>Select Game</h5>
                        <select class="form-select" name="game_id" id="game_id" required>
                            <option value="" selected disabled>Choose a game...</option>
                            {% for game in upcoming_games %}
                            <option value="{{ game['id'] }}" {% if selected_game_id and selected_game_id|int == game['id'] %}selected{% endif %}
                                data-home="{{ game['home'] }}" data-away="{{ game['away'] }}">
                                {{ game['date'] }} - {{ game['time'] }}: {{ game['away'] }} @ {{ game['home'] }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <hr class="my-4">

                    <!-- Strategy Tabs -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Bidding Strategies</h5>
                            <small class="text-muted">Create multiple strategies for different scenarios</small>
                        </div>

                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs" id="strategyTabs" role="tablist">
                            <!-- Tabs will be populated by JavaScript -->
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content border border-top-0 p-3" id="strategyTabContent">
                            <!-- Tab panes will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-grid gap-2">
                        <!-- FIXED: Button with correct styling and text -->
                        <button type="submit" class="btn btn-{{ 'info' if existing_strategies else 'primary' }} btn-lg" id="saveAllBtn">
                            <i class="fas fa-check-circle me-2"></i>
                            {% if existing_strategies %}Edit/Update Strategies for {{ moment['name'] }}{% else %}Save All Strategies for {{ moment['name'] }}{% endif %}
                        </button>

                        <!-- Cancel button -->
                        {% if selected_game_id %}
                        <a href="{{ url_for('game_detail', game_id=selected_game_id) }}" class="btn btn-outline-secondary">Cancel</a>
                        {% else %}
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Cancel</a>
                        {% endif %}

                        <!-- Delete buttons for strategies (populated by JS) -->
                        <div id="deleteButtonsContainer"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4 sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Strategy Summary</h5>
            </div>
            <div class="card-body">
                <div id="strategy-summary">
                    <p><strong>Moment Type:</strong> <span id="summary-moment">{{ moment['name'] }}</span></p>
                    <p><strong>Game:</strong> <span id="summary-game">
                        {% if selected_game_id %}
                            {% for game in upcoming_games %}
                                {% if game.id == selected_game_id %}
                                    {{ game.date }} - {{ game.time }}: {{ game.away }} @ {{ game.home }}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            Not selected
                        {% endif %}
                    </span></p>

                    <div id="strategySummaryList">
                        <!-- Strategy summaries will be populated by JavaScript -->
                    </div>
                </div>

                <hr>

                <div class="mb-3">
                    <h6>Estimated Stats</h6>
                    <p><strong>Total Strategies:</strong> <span id="total-strategies">1</span></p>
                    <p><strong>Combined Max Bid:</strong> $<span id="combined-max-bid">7,000</span></p>
                    <p><strong>Est. Win Rate:</strong> <span id="est-win-rate">62%</span></p>
                    <p><strong>Est. Impressions:</strong> <span id="est-impressions">500,000+</span></p>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> Your strategies will automatically bid in real-time when conditions are met during the game.
                </div>
            </div>
            <div class="card-footer">
                <small class="text-muted">Strategies can be edited or paused at any time from your dashboard.</small>
            </div>
        </div>
    </div>
</div>

<!-- Player Selection Modal -->
<div class="modal fade" id="playerSelectionModal" tabindex="-1" aria-labelledby="playerSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="playerSelectionModalLabel">Select Players for Bidding Strategy</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="playerSearchInput" placeholder="Search by player name...">
                            <button class="btn btn-outline-secondary" type="button" id="searchPlayerBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="positionFilter">
                            <option value="all">All Positions</option>
                            <option value="C">Center</option>
                            <option value="LW">Left Wing</option>
                            <option value="RW">Right Wing</option>
                            <option value="D">Defense</option>
                            <option value="G">Goalie</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="teamFilter">
                            <option value="all">All Teams</option>
                            <!-- Team options will be populated dynamically based on selected game -->
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Available Players</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="playersTable">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Team</th>
                                                <th>Pos</th>
                                                <th>#</th>
                                                <th>Stats</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Players will be populated dynamically based on selected game -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Selected Players</h5>
                            </div>
                            <div class="card-body">
                                <div id="selectedPlayersContainer">
                                    <p id="noPlayersMessage" class="text-muted">No players selected. Click the "+" button to add players.</p>
                                    <ul id="selectedPlayersList" class="list-group mb-3">
                                        <!-- Selected players will be listed here -->
                                    </ul>
                                </div>

                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Bidding will only trigger for moments involving your selected players.
                                </div>

                                <div class="d-grid">
                                    <button type="button" class="btn btn-success" id="confirmPlayerSelection">
                                        <i class="fas fa-check me-1"></i> Confirm Selection
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Sample player data for reference
    const playerData = {
        // Rangers
        "NYR-1": {"id": "NYR-1", "name": "Igor Shesterkin", "team": "NYR", "teamName": "New York Rangers", "position": "G", "number": 31, "stats": "GAA: 2.48, SV%: .916, SO: 3"},
        "NYR-2": {"id": "NYR-2", "name": "Artemi Panarin", "team": "NYR", "teamName": "New York Rangers", "position": "LW", "number": 10, "stats": "32 G, 47 A, 79 PTS"},
        "NYR-3": {"id": "NYR-3", "name": "Mika Zibanejad", "team": "NYR", "teamName": "New York Rangers", "position": "C", "number": 93, "stats": "28 G, 39 A, 67 PTS"},
        "NYR-4": {"id": "NYR-4", "name": "Adam Fox", "team": "NYR", "teamName": "New York Rangers", "position": "D", "number": 23, "stats": "11 G, 54 A, 65 PTS"},
        "NYR-5": {"id": "NYR-5", "name": "Chris Kreider", "team": "NYR", "teamName": "New York Rangers", "position": "LW", "number": 20, "stats": "36 G, 21 A, 57 PTS"},

        // Bruins
        "BOS-1": {"id": "BOS-1", "name": "Jeremy Swayman", "team": "BOS", "teamName": "Boston Bruins", "position": "G", "number": 1, "stats": "GAA: 2.32, SV%: .921, SO: 4"},
        "BOS-2": {"id": "BOS-2", "name": "David Pastrnak", "team": "BOS", "teamName": "Boston Bruins", "position": "RW", "number": 88, "stats": "43 G, 38 A, 81 PTS"},
        "BOS-3": {"id": "BOS-3", "name": "Brad Marchand", "team": "BOS", "teamName": "Boston Bruins", "position": "LW", "number": 63, "stats": "26 G, 42 A, 68 PTS"},
        "BOS-4": {"id": "BOS-4", "name": "Charlie McAvoy", "team": "BOS", "teamName": "Boston Bruins", "position": "D", "number": 73, "stats": "8 G, 42 A, 50 PTS"},
        "BOS-5": {"id": "BOS-5", "name": "Hampus Lindholm", "team": "BOS", "teamName": "Boston Bruins", "position": "D", "number": 27, "stats": "9 G, 28 A, 37 PTS"},

        // Maple Leafs
        "TOR-1": {"id": "TOR-1", "name": "Auston Matthews", "team": "TOR", "teamName": "Toronto Maple Leafs", "position": "C", "number": 34, "stats": "51 G, 27 A, 78 PTS"},
        "TOR-2": {"id": "TOR-2", "name": "Mitch Marner", "team": "TOR", "teamName": "Toronto Maple Leafs", "position": "RW", "number": 16, "stats": "27 G, 53 A, 80 PTS"},
        "TOR-3": {"id": "TOR-3", "name": "William Nylander", "team": "TOR", "teamName": "Toronto Maple Leafs", "position": "RW", "number": 88, "stats": "33 G, 39 A, 72 PTS"},
        "TOR-4": {"id": "TOR-4", "name": "John Tavares", "team": "TOR", "teamName": "Toronto Maple Leafs", "position": "C", "number": 91, "stats": "29 G, 38 A, 67 PTS"},
        "TOR-5": {"id": "TOR-5", "name": "Joseph Woll", "team": "TOR", "teamName": "Toronto Maple Leafs", "position": "G", "number": 60, "stats": "GAA: 2.65, SV%: .912, SO: 1"},

        // Canadiens
        "MTL-1": {"id": "MTL-1", "name": "Cole Caufield", "team": "MTL", "teamName": "Montreal Canadiens", "position": "RW", "number": 22, "stats": "26 G, 20 A, 46 PTS"},
        "MTL-2": {"id": "MTL-2", "name": "Nick Suzuki", "team": "MTL", "teamName": "Montreal Canadiens", "position": "C", "number": 14, "stats": "22 G, 34 A, 56 PTS"},
        "MTL-3": {"id": "MTL-3", "name": "Mike Matheson", "team": "MTL", "teamName": "Montreal Canadiens", "position": "D", "number": 8, "stats": "8 G, 31 A, 39 PTS"},
        "MTL-4": {"id": "MTL-4", "name": "Sam Montembeault", "team": "MTL", "teamName": "Montreal Canadiens", "position": "G", "number": 35, "stats": "GAA: 3.05, SV%: .904, SO: 1"},
        "MTL-5": {"id": "MTL-5", "name": "Kirby Dach", "team": "MTL", "teamName": "Montreal Canadiens", "position": "C", "number": 77, "stats": "14 G, 24 A, 38 PTS"},

        // Oilers
        "EDM-1": {"id": "EDM-1", "name": "Connor McDavid", "team": "EDM", "teamName": "Edmonton Oilers", "position": "C", "number": 97, "stats": "42 G, 66 A, 108 PTS"},
        "EDM-2": {"id": "EDM-2", "name": "Leon Draisaitl", "team": "EDM", "teamName": "Edmonton Oilers", "position": "C", "number": 29, "stats": "38 G, 58 A, 96 PTS"},
        "EDM-3": {"id": "EDM-3", "name": "Zach Hyman", "team": "EDM", "teamName": "Edmonton Oilers", "position": "LW", "number": 18, "stats": "33 G, 31 A, 64 PTS"},
        "EDM-4": {"id": "EDM-4", "name": "Evan Bouchard", "team": "EDM", "teamName": "Edmonton Oilers", "position": "D", "number": 2, "stats": "12 G, 35 A, 47 PTS"},
        "EDM-5": {"id": "EDM-5", "name": "Stuart Skinner", "team": "EDM", "teamName": "Edmonton Oilers", "position": "G", "number": 74, "stats": "GAA: 2.68, SV%: .908, SO: 2"},

        // Flames
        "CGY-1": {"id": "CGY-1", "name": "Jacob Markstrom", "team": "CGY", "teamName": "Calgary Flames", "position": "G", "number": 25, "stats": "GAA: 2.75, SV%: .911, SO: 2"},
        "CGY-2": {"id": "CGY-2", "name": "Nazem Kadri", "team": "CGY", "teamName": "Calgary Flames", "position": "C", "number": 91, "stats": "24 G, 37 A, 61 PTS"},
        "CGY-3": {"id": "CGY-3", "name": "Elias Lindholm", "team": "CGY", "teamName": "Calgary Flames", "position": "C", "number": 28, "stats": "22 G, 28 A, 50 PTS"},
        "CGY-4": {"id": "CGY-4", "name": "Rasmus Andersson", "team": "CGY", "teamName": "Calgary Flames", "position": "D", "number": 4, "stats": "10 G, 36 A, 46 PTS"},
        "CGY-5": {"id": "CGY-5", "name": "Blake Coleman", "team": "CGY", "teamName": "Calgary Flames", "position": "C", "number": 20, "stats": "23 G, 19 A, 42 PTS"}
    };

    // Team name mapping
    const teamMapping = {
        "New York Rangers": "NYR",
        "Boston Bruins": "BOS",
        "Toronto Maple Leafs": "TOR",
        "Montreal Canadiens": "MTL",
        "Edmonton Oilers": "EDM",
        "Calgary Flames": "CGY"
    };

    // Strategy management
    let strategies = [];
    let strategyCounter = 1;
    let activeStrategyIndex = 0;
    let selectedHomeTeam = "";
    let selectedAwayTeam = "";
    let currentPlayerModalStrategyIndex = 0;

    // Initialize existing strategies from backend
    const existingStrategies = {{ existing_strategies|tojson|safe if existing_strategies else '[]' }};
    const momentName = "{{ moment['name'] }}";

    document.addEventListener('DOMContentLoaded', function() {
        initializeStrategies();
        setupEventListeners();
        updateGameInfo();
    });

    function initializeStrategies() {
        // Update the submit button based on whether we have existing strategies
        const submitBtn = document.getElementById('saveAllBtn');
        
        if (existingStrategies && existingStrategies.length > 0) {
            // We have existing strategies - show Edit/Update button
            submitBtn.className = 'btn btn-info btn-lg';
            submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Edit/Update Strategies for ' + momentName;
            
            // Load existing strategies
            strategies = existingStrategies.map((strategy, index) => ({
                id: strategy.id || null,
                name: strategy.name || `${momentName} Strategy ${index + 1}`,
                base_bid: strategy.base_bid || 3000,
                bid_increment: strategy.bid_increment || 500,
                max_bid: strategy.max_bid || 7000,
                team_focus: strategy.team_focus || 'both',
                player_focus: strategy.player_focus || '',
                period_restrictions: strategy.period_restrictions || '',
                ad_content: strategy.ad_content || 'https://example.com/test-ad.mp4',
                specific_scenario: strategy.specific_scenario || 'both'
            }));
            strategyCounter = strategies.length + 1;
        } else {
            // No existing strategies - show Save All button
            submitBtn.className = 'btn btn-primary btn-lg';
            submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Save All Strategies for ' + momentName;
            
            // Create first default strategy
            strategies = [{
                id: null,
                name: `${momentName} Strategy`,
                base_bid: 3000,
                bid_increment: 500,
                max_bid: 7000,
                team_focus: 'both',
                player_focus: '',
                period_restrictions: '',
                ad_content: 'https://example.com/test-ad.mp4',
                specific_scenario: 'both'
            }];
            strategyCounter = 2;
        }

        renderStrategyTabs();
        renderActiveStrategyForm();
        updateSummary();
    }

    function setupEventListeners() {
        // Add strategy button
        document.getElementById('addStrategyBtn').addEventListener('click', addStrategy);

        // Game selection
        const gameSelect = document.getElementById('game_id');
        if (gameSelect) {
            gameSelect.addEventListener('change', updateGameInfo);
            if (gameSelect.value) {
                updateGameInfo();
            }
        }

        // Form submission
        document.getElementById('multiStrategyForm').addEventListener('submit', handleFormSubmission);

        // Player modal events
        setupPlayerModalEvents();
    }

    function addStrategy() {
        if (strategies.length >= 10) {
            alert('Maximum of 10 strategies allowed per moment type.');
            return;
        }

        const newStrategy = {
            id: null,
            name: `${momentName} Strategy ${strategyCounter}`,
            base_bid: 3000,
            bid_increment: 500,
            max_bid: 7000,
            team_focus: 'both',
            player_focus: '',
            period_restrictions: '',
            ad_content: 'https://example.com/test-ad.mp4',
            specific_scenario: 'both'
        };

        strategies.push(newStrategy);
        strategyCounter++;
        activeStrategyIndex = strategies.length - 1;

        renderStrategyTabs();
        renderActiveStrategyForm();
        updateSummary();
        updateDeleteButtons();
    }

function removeStrategy(index) {
    if (confirm(`Are you sure you want to delete "${strategies[index].name}"?`)) {
        strategies.splice(index, 1);

        // If no strategies left, we need to delete all strategies for this moment from the backend
        if (strategies.length === 0) {
            // Get the game_id and moment_id
            const gameSelect = document.getElementById('game_id');
            const gameId = gameSelect ? gameSelect.value : null;
            const momentId = "{{ moment['id'] }}";
            
            // Create a form to submit the deletion request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete_all_strategies/${momentId}/${gameId}`;
            document.body.appendChild(form);
            form.submit();
            return;
        }

        // Rest of the function remains the same...
        if (activeStrategyIndex >= strategies.length) {
            activeStrategyIndex = strategies.length - 1;
        }

        renderStrategyTabs();
        renderActiveStrategyForm();
        updateSummary();
        updateDeleteButtons();
    }
}

    function renderStrategyTabs() {
        const tabsContainer = document.getElementById('strategyTabs');
        tabsContainer.innerHTML = '';

        strategies.forEach((strategy, index) => {
            const tabId = `strategy-tab-${index}`;
            const paneId = `strategy-pane-${index}`;

            const li = document.createElement('li');
            li.className = 'nav-item';
            li.setAttribute('role', 'presentation');

            const button = document.createElement('button');
            // Updated styling: dark blue for active, light blue for inactive
            if (index === activeStrategyIndex) {
                button.className = 'nav-link active bg-primary text-white border-primary';
            } else {
                button.className = 'nav-link bg-info text-white border-info';
            }

            button.id = tabId;
            button.setAttribute('data-bs-toggle', 'tab');
            button.setAttribute('data-bs-target', `#${paneId}`);
            button.setAttribute('type', 'button');
            button.setAttribute('role', 'tab');
            button.setAttribute('aria-controls', paneId);
            button.setAttribute('aria-selected', index === activeStrategyIndex ? 'true' : 'false');
            button.setAttribute('draggable', 'true');
            button.textContent = strategy.name;

            // Add drag and drop functionality
            button.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', index);
                button.classList.add('dragging');
            });

            button.addEventListener('dragend', () => {
                button.classList.remove('dragging');
            });

            button.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            button.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const dropIndex = index;

                if (draggedIndex !== dropIndex) {
                    // Reorder strategies
                    const draggedStrategy = strategies.splice(draggedIndex, 1)[0];
                    strategies.splice(dropIndex, 0, draggedStrategy);

                    // Update active index
                    if (activeStrategyIndex === draggedIndex) {
                        activeStrategyIndex = dropIndex;
                    } else if (activeStrategyIndex > draggedIndex && activeStrategyIndex <= dropIndex) {
                        activeStrategyIndex--;
                    } else if (activeStrategyIndex < draggedIndex && activeStrategyIndex >= dropIndex) {
                        activeStrategyIndex++;
                    }

                    renderStrategyTabs();
                    renderActiveStrategyForm();
                    updateSummary();
                }
            });

            // Tab click handler
            button.addEventListener('click', () => {
                saveCurrentStrategyForm();
                activeStrategyIndex = index;
                renderStrategyTabs();
                renderActiveStrategyForm();
                updateSummary();
            });

            li.appendChild(button);
            tabsContainer.appendChild(li);
        });
    }

    function renderActiveStrategyForm() {
        const contentContainer = document.getElementById('strategyTabContent');
        const strategy = strategies[activeStrategyIndex];

        contentContainer.innerHTML = `
            <div class="row mb-3">
                <div class="col-md-8">
                    <label for="strategy-name" class="form-label">Strategy Name</label>
                    <input type="text" class="form-control" id="strategy-name" value="${strategy.name}"
                           onchange="updateStrategyName(${activeStrategyIndex}, this.value)">
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <h6>Bidding Parameters</h6>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="base_bid_${activeStrategyIndex}" class="form-label">Base Bid Amount ($)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control strategy-input" id="base_bid_${activeStrategyIndex}"
                               name="base_bid_${activeStrategyIndex}" min="1000" step="100" value="${strategy.base_bid}" required>
                    </div>
                    <div class="form-text">Your starting bid for each ${momentName} moment</div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="bid_increment_${activeStrategyIndex}" class="form-label">Bid Increment ($)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control strategy-input" id="bid_increment_${activeStrategyIndex}"
                               name="bid_increment_${activeStrategyIndex}" min="100" step="100" value="${strategy.bid_increment}" required>
                    </div>
                    <div class="form-text">Amount to increase bid during competitive auctions</div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="max_bid_${activeStrategyIndex}" class="form-label">Maximum Bid Amount ($)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control strategy-input" id="max_bid_${activeStrategyIndex}"
                               name="max_bid_${activeStrategyIndex}" min="1000" step="100" value="${strategy.max_bid}" required>
                    </div>
                    <div class="form-text">Your system will never bid above this amount</div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <h6>Strategic Focus</h6>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="team_focus_${activeStrategyIndex}" class="form-label">Team Focus</label>
                    <select class="form-select strategy-input" id="team_focus_${activeStrategyIndex}" name="team_focus_${activeStrategyIndex}" required>
                        <option value="both" ${strategy.team_focus === 'both' ? 'selected' : ''}>Both Teams</option>
                        <option value="home" ${strategy.team_focus === 'home' ? 'selected' : ''}>Home Team Only</option>
                        <option value="away" ${strategy.team_focus === 'away' ? 'selected' : ''}>Away Team Only</option>
                    </select>
                    <div class="form-text">Select which team's ${momentName} moments you want to bid on</div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="player_focus_${activeStrategyIndex}" class="form-label">Player Focus (Optional)</label>
                    <div class="input-group">
                        <input type="text" class="form-control strategy-input" id="player_focus_${activeStrategyIndex}"
                               name="player_focus_${activeStrategyIndex}" placeholder="e.g., Connor McDavid, Sidney Crosby"
                               value="${strategy.player_focus}">
                        <button type="button" class="btn btn-outline-primary" onclick="openPlayerModal(${activeStrategyIndex})">
                            <i class="fas fa-users me-1"></i> Browse Players
                        </button>
                    </div>
                    <div class="form-text">Please select a game first to browse players from those teams</div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <h6>Time and Period Restrictions</h6>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="period_restrictions_${activeStrategyIndex}" class="form-label">Period Restrictions</label>
                    <select class="form-select strategy-input" id="period_restrictions_${activeStrategyIndex}" name="period_restrictions_${activeStrategyIndex}">
                        <option value="" ${!strategy.period_restrictions ? 'selected' : ''}>All Periods</option>
                        <option value="1" ${strategy.period_restrictions === '1' ? 'selected' : ''}>1st Period Only</option>
                        <option value="2" ${strategy.period_restrictions === '2' ? 'selected' : ''}>2nd Period Only</option>
                        <option value="3" ${strategy.period_restrictions === '3' ? 'selected' : ''}>3rd Period Only</option>
                        <option value="1,2" ${strategy.period_restrictions === '1,2' ? 'selected' : ''}>1st and 2nd Periods</option>
                        <option value="2,3" ${strategy.period_restrictions === '2,3' ? 'selected' : ''}>2nd and 3rd Periods</option>
                        <option value="OT" ${strategy.period_restrictions === 'OT' ? 'selected' : ''}>Overtime Only</option>
                        <option value="SO" ${strategy.period_restrictions === 'SO' ? 'selected' : ''}>Shootout Only</option>
                    </select>
                    <div class="form-text">Restrict your bidding to specific periods</div>
                </div>

                ${momentName === 'Overtime Goal/Shootout' ? `
                <div class="col-md-6 mb-3">
                    <label for="specific_scenario_${activeStrategyIndex}" class="form-label">Specific Scenario</label>
                    <select class="form-select strategy-input" id="specific_scenario_${activeStrategyIndex}" name="specific_scenario_${activeStrategyIndex}">
                        <option value="both" ${strategy.specific_scenario === 'both' ? 'selected' : ''}>Both Overtime & Shootout</option>
                        <option value="OT" ${strategy.specific_scenario === 'OT' ? 'selected' : ''}>Overtime Goal Only</option>
                        <option value="SO" ${strategy.specific_scenario === 'SO' ? 'selected' : ''}>Shootout Only</option>
                    </select>
                    <div class="form-text">For overtime/shootout goals, specify which scenario you want to bid on</div>
                </div>
                ` : ''}
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <h6>Ad Content</h6>
                </div>
                <div class="col-12 mb-3">
                    <label for="ad_content_${activeStrategyIndex}" class="form-label">Ad Content URL</label>
                    <input type="text" class="form-control strategy-input" id="ad_content_${activeStrategyIndex}"
                           name="ad_content_${activeStrategyIndex}" placeholder="https://yourdomain.com/ads/nhl-ad.mp4"
                           value="${strategy.ad_content}">
                    <div class="form-text">URL to your ad content that will appear in the instant replay overlay (placeholder URL is provided for testing)</div>
                </div>
            </div>
        `;

        // Add event listeners to form inputs
        const inputs = contentContainer.querySelectorAll('.strategy-input');
        inputs.forEach(input => {
            input.addEventListener('change', () => {
                saveCurrentStrategyForm();
                updateSummary();
            });
        });

        updateDeleteButtons();
    }

    function updateDeleteButtons() {
        const container = document.getElementById('deleteButtonsContainer');
        container.innerHTML = '';

        // Only show delete buttons if there are strategies that can be deleted
        if (strategies.length > 0 && (existingStrategies.length > 0 || strategies.length > 1)) {
            strategies.forEach((strategy, index) => {
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'btn btn-outline-danger btn-sm me-2 mb-2';
                deleteBtn.innerHTML = `<i class="fas fa-trash-alt me-1"></i> Delete "${strategy.name}"`;
                deleteBtn.onclick = () => removeStrategy(index);
                container.appendChild(deleteBtn);
            });
        }
    }

    function updateStrategyName(index, newName) {
        strategies[index].name = newName;
        renderStrategyTabs();
        updateSummary();
    }

    function saveCurrentStrategyForm() {
        const strategy = strategies[activeStrategyIndex];

        // Save all form values
        const getValue = (id) => {
            const element = document.getElementById(id);
            return element ? element.value : '';
        };

        strategy.base_bid = parseInt(getValue(`base_bid_${activeStrategyIndex}`)) || strategy.base_bid;
        strategy.bid_increment = parseInt(getValue(`bid_increment_${activeStrategyIndex}`)) || strategy.bid_increment;
        strategy.max_bid = parseInt(getValue(`max_bid_${activeStrategyIndex}`)) || strategy.max_bid;
        strategy.team_focus = getValue(`team_focus_${activeStrategyIndex}`) || strategy.team_focus;
        strategy.player_focus = getValue(`player_focus_${activeStrategyIndex}`) || strategy.player_focus;
        strategy.period_restrictions = getValue(`period_restrictions_${activeStrategyIndex}`) || strategy.period_restrictions;
        strategy.ad_content = getValue(`ad_content_${activeStrategyIndex}`) || strategy.ad_content;
        strategy.specific_scenario = getValue(`specific_scenario_${activeStrategyIndex}`) || strategy.specific_scenario;
    }

    function updateSummary() {
        const summaryContainer = document.getElementById('strategySummaryList');
        const totalStrategiesSpan = document.getElementById('total-strategies');
        const combinedMaxBidSpan = document.getElementById('combined-max-bid');

        let summaryHTML = '';
        let totalMaxBid = 0;

        strategies.forEach((strategy, index) => {
            totalMaxBid += strategy.max_bid;

            summaryHTML += `
                <div class="mb-3 p-2 border rounded ${index === activeStrategyIndex ? 'bg-light' : ''}">
                    <h6 class="mb-1">${strategy.name}</h6>
                    <small>
                        <strong>Bid Range:</strong> $${strategy.base_bid.toLocaleString()} - $${strategy.max_bid.toLocaleString()}<br>
                        <strong>Team:</strong> ${strategy.team_focus === 'both' ? 'Both Teams' :
                                                 strategy.team_focus === 'home' ? 'Home Team' : 'Away Team'}<br>
                        ${strategy.player_focus ? `<strong>Players:</strong> ${strategy.player_focus}<br>` : ''}
                        ${strategy.period_restrictions ? `<strong>Periods:</strong> ${strategy.period_restrictions}<br>` : ''}
                    </small>
                </div>
            `;
        });

        summaryContainer.innerHTML = summaryHTML;
        totalStrategiesSpan.textContent = strategies.length;
        combinedMaxBidSpan.textContent = totalMaxBid.toLocaleString();
    }

    function updateGameInfo() {
        const gameSelect = document.getElementById('game_id');
        const summaryGame = document.getElementById('summary-game');

        if (gameSelect && gameSelect.value) {
            const selectedOption = gameSelect.options[gameSelect.selectedIndex];
            selectedHomeTeam = selectedOption.getAttribute('data-home');
            selectedAwayTeam = selectedOption.getAttribute('data-away');
            summaryGame.textContent = selectedOption.text || 'Not selected';
        }
    }

    function handleFormSubmission(e) {
        e.preventDefault();

        // Save current form state
        saveCurrentStrategyForm();

        // Create hidden inputs for all strategies
        const form = e.target;

        // Remove any existing strategy data inputs
        form.querySelectorAll('input[name^="strategies"]').forEach(input => input.remove());

        // Add strategy data as JSON
        const strategiesInput = document.createElement('input');
        strategiesInput.type = 'hidden';
        strategiesInput.name = 'strategies_data';
        strategiesInput.value = JSON.stringify(strategies);
        form.appendChild(strategiesInput);

        // Submit the form
        form.submit();
    }

    // Player modal functions
    function openPlayerModal(strategyIndex) {
        currentPlayerModalStrategyIndex = strategyIndex;
        const gameSelect = document.getElementById('game_id');

        if (!gameSelect.value) {
            alert('Please select a game first');
            return;
        }

        updatePlayerTable();
        const modal = new bootstrap.Modal(document.getElementById('playerSelectionModal'));
        modal.show();
    }

    function setupPlayerModalEvents() {
        // Initialize selected players array
        let selectedPlayers = [];

        // Modal event listeners
        document.getElementById('confirmPlayerSelection').addEventListener('click', function() {
            const playerNames = selectedPlayers.map(p => p.name).join(', ');
            const playerInput = document.getElementById(`player_focus_${currentPlayerModalStrategyIndex}`);
            if (playerInput) {
                playerInput.value = playerNames;
                saveCurrentStrategyForm();
                updateSummary();
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('playerSelectionModal'));
            if (modal) {
                modal.hide();
            }
        });

        // Add player to selection
        function addPlayerToSelection() {
            const row = this.closest('tr');
            const playerId = row.getAttribute('data-player-id');
            const playerName = row.cells[0].textContent;
            const playerTeam = row.cells[1].textContent;
            const playerPosition = row.cells[2].textContent;

            if (!selectedPlayers.some(p => p.id === playerId)) {
                selectedPlayers.push({
                    id: playerId,
                    name: playerName,
                    team: playerTeam,
                    position: playerPosition
                });

                updateSelectedPlayersList();
            }
        }

        // Update the selected players list
        function updateSelectedPlayersList() {
            const selectedPlayersList = document.getElementById('selectedPlayersList');
            const noPlayersMessage = document.getElementById('noPlayersMessage');

            if (selectedPlayers.length > 0) {
                noPlayersMessage.style.display = 'none';
                selectedPlayersList.innerHTML = '';

                selectedPlayers.forEach(player => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.innerHTML = `
                        <div>
                            <strong>${player.name}</strong>
                            <span class="ms-2 badge bg-secondary">${player.team} | ${player.position}</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger remove-player" data-player-id="${player.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    selectedPlayersList.appendChild(listItem);
                });

                // Add event listeners to remove buttons
                document.querySelectorAll('.remove-player').forEach(button => {
                    button.addEventListener('click', function() {
                        const playerId = this.getAttribute('data-player-id');
                        selectedPlayers = selectedPlayers.filter(p => p.id !== playerId);
                        updateSelectedPlayersList();
                    });
                });
            } else {
                noPlayersMessage.style.display = 'block';
                selectedPlayersList.innerHTML = '';
            }
        }

        // Update player table based on selected game
        function updatePlayerTable() {
            const playersTable = document.getElementById('playersTable').querySelector('tbody');
            const teamFilter = document.getElementById('teamFilter');

            // Clear existing players
            playersTable.innerHTML = '';

            if (!selectedHomeTeam && !selectedAwayTeam) return;

            const homeTeamCode = teamMapping[selectedHomeTeam];
            const awayTeamCode = teamMapping[selectedAwayTeam];

            // Filter players for selected teams
            const gamePlayersIds = Object.keys(playerData).filter(id => {
                const player = playerData[id];
                return player.team === homeTeamCode || player.team === awayTeamCode;
            });

            // Add player rows to table
            gamePlayersIds.forEach(id => {
                const player = playerData[id];
                const row = document.createElement('tr');
                row.setAttribute('data-player-id', player.id);
                row.setAttribute('data-team', player.team);
                row.setAttribute('data-position', player.position);

                row.innerHTML = `
                    <td>${player.name}</td>
                    <td>${player.teamName}</td>
                    <td>${player.position}</td>
                    <td>${player.number}</td>
                    <td>${player.stats}</td>
                    <td><button class="btn btn-sm btn-primary add-player-btn"><i class="fas fa-plus"></i></button></td>
                `;

                playersTable.appendChild(row);
            });

            // Reattach event listeners to new buttons
            document.querySelectorAll('.add-player-btn').forEach(button => {
                button.addEventListener('click', addPlayerToSelection);
            });

            // Update team filter
            teamFilter.innerHTML = '<option value="all">All Teams</option>';
            if (homeTeamCode) {
                const option = document.createElement('option');
                option.value = homeTeamCode;
                option.textContent = selectedHomeTeam;
                teamFilter.appendChild(option);
            }
            if (awayTeamCode) {
                const option = document.createElement('option');
                option.value = awayTeamCode;
                option.textContent = selectedAwayTeam;
                teamFilter.appendChild(option);
            }
        }

        // Filter functionality
        function filterPlayers() {
            const playerSearchInput = document.getElementById('playerSearchInput');
            const positionFilter = document.getElementById('positionFilter');
            const teamFilter = document.getElementById('teamFilter');

            const searchText = playerSearchInput.value.toLowerCase();
            const position = positionFilter.value;
            const team = teamFilter.value;

            document.querySelectorAll('#playersTable tbody tr').forEach(row => {
                const playerName = row.cells[0].textContent.toLowerCase();
                const playerTeam = row.getAttribute('data-team');
                const playerPosition = row.getAttribute('data-position');

                const matchesSearch = playerName.includes(searchText);
                const matchesPosition = position === 'all' || playerPosition === position;
                const matchesTeam = team === 'all' || playerTeam === team;

                if (matchesSearch && matchesPosition && matchesTeam) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Search and filter event listeners
        document.getElementById('searchPlayerBtn').addEventListener('click', filterPlayers);
        document.getElementById('playerSearchInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                filterPlayers();
            }
        });
        document.getElementById('positionFilter').addEventListener('change', filterPlayers);
        document.getElementById('teamFilter').addEventListener('change', filterPlayers);

        // Store functions in window for access from onclick handlers
        window.addPlayerToSelection = addPlayerToSelection;
        window.updateSelectedPlayersList = updateSelectedPlayersList;
        window.updatePlayerTable = updatePlayerTable;
    }

    // Make functions available globally for onclick handlers
    window.updateStrategyName = updateStrategyName;
    window.openPlayerModal = openPlayerModal;
    window.removeStrategy = removeStrategy;
</script>

<style>
.nav-link.dragging {
    opacity: 0.5;
}

.nav-link[draggable="true"]:hover {
    cursor: move;
}

.strategy-tab-content {
    min-height: 400px;
}

#strategySummaryList .bg-light {
    border-color: #007bff !important;
}

/* Custom tab styling */
.nav-tabs .nav-link.bg-primary {
    background-color: #007bff !important;
    border-color: #007bff !important;
    color: white !important;
}

.nav-tabs .nav-link.bg-info {
    background-color: #17a2b8 !important;
    border-color: #17a2b8 !important;
    color: white !important;
}

.nav-tabs .nav-link.bg-primary:hover,
.nav-tabs .nav-link.bg-info:hover {
    opacity: 0.8;
}

.nav-tabs .nav-link {
    margin-bottom: -1px;
}

/* Additional styling for the submit button */
.btn-info {
    background-color: #17a2b8 !important;
    border-color: #17a2b8 !important;
    color: white !important;
}

.btn-info:hover {
    background-color: #138496 !important;
    border-color: #117a8b !important;
}
</style>
{% endblock %}
